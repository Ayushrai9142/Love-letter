<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="jnphjQTW-i8neDl8TrT6alPY0zyY1kQ2sZLq9L3TSik" />
    
    <title>Recipient Details</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SJWLXHTLJL"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-SJWLXHTLJL');
    </script>

    <script>
        // âœ… **Check if User is Logged In**
        if (!sessionStorage.getItem("loggedIn")) {
            window.location.href = "login.html"; // ðŸ”„ Redirect to login if not logged in
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="recipient-box">
            <h1>ðŸ’– Customize Your Love Letter ðŸ’–</h1>
            <p class="love-text">
                Fill in the details below to create a special love letter for your soulmate.
            </p>

            <form id="recipientForm">
                <!-- Your Name (Mandatory) -->
                <label for="yourName">Your Name: <span class="required-star">*</span></label>
                <input type="text" id="yourName" name="yourName" placeholder="Enter your name" required>

                <!-- Recipient Name (Optional) -->
                <label for="recipientName">Recipient's Name:</label>
                <input type="text" id="recipientName" name="recipientName" placeholder="Enter recipient's name">

                <!-- Custom Message (Optional) -->
                <label for="customMessage">Custom Message (Optional):</label>
                <textarea id="customMessage" name="customMessage" placeholder="Write a personal love message..."></textarea>

                <!-- Next Button -->
                <button type="submit" class="get-started">Next</button>
            </form>
        </div>
    </div>

    <script>
        document.getElementById("recipientForm").addEventListener("submit", async function(event) {
            event.preventDefault();

            // Input Fields
            let yourName = document.getElementById("yourName").value.trim();
            let recipientName = document.getElementById("recipientName").value.trim();
            let customMessage = document.getElementById("customMessage").value.trim();

            // Validation: Your Name Required
            if (!yourName.replace(/\s/g, '').length) {
                alert("Please enter your name. This field is required!");
                return;
            }

            // Custom Message Length Validation
            if (customMessage.length > 300) { // 300 characters limit
                alert("Your custom message is too long! Please keep it under 300 characters.");
                return;
            }

            // Store Data in Local Storage
            localStorage.setItem("yourName", yourName);
            localStorage.setItem("recipientName", recipientName);
            localStorage.setItem("customMessage", customMessage);

            // âœ… **Recipient details ko silently backend pe send karna**
            fetch("/.netlify/functions/sendRecipientDetails", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    sender: yourName, 
                    recipient: recipientName,
                    message: customMessage // âœ… Fix: Message backend pe bhej diya
                })
            }).catch(error => console.error("Error sending recipient details:", error));

            // âœ… **Redirect to Payment Page with URL Parameters**
            let encodedMessage = encodeURIComponent(customMessage);
            window.location.href = `payment.html?sender=${encodeURIComponent(yourName)}&recipient=${encodeURIComponent(recipientName)}&message=${encodedMessage}`;
        });
    </script>
</body>
</html>
